/* ============================================================
   DASHBOARD PAGE — Main overview / homepage
   
   Displays:
   - Key portfolio metrics (stat cards)
   - Portfolio value chart (mini)
   - Recent trades (last 5)
   - Active positions snapshot
   - Recent activity feed
   
   All data is generated by the simulator.
   In production, replace simulator calls with tunnel data.
   ============================================================ */

'use client';

import { useState, useEffect } from 'react';
import {
  DollarSign,
  TrendingUp,
  BarChart3,
  Target,
  Zap,
  Award,
  Shield,
  Activity,
} from 'lucide-react';
import ClientLayout from '@/components/ClientLayout';
import StatCard from '@/components/StatCard';
import PortfolioChart from '@/components/PortfolioChart';
import TradeTable from '@/components/TradeTable';
import PositionsList from '@/components/PositionsList';
import ActivityFeed from '@/components/ActivityFeed';
import {
  generateDashboardStats,
  generatePortfolioHistory,
  generateTradeHistory,
  generatePositions,
  generateActivityLogs,
  generateTrade,
  SIMULATED_MARKETS,
} from '@/lib/simulator';
import { DashboardStats, PortfolioSnapshot, Trade, Position, ActivityLog } from '@/lib/types';
import { formatCurrency, formatPercent } from '@/lib/utils';

export default function DashboardPage() {
  /* ---- State for all dashboard data ---- */
  const [stats, setStats] = useState<DashboardStats | null>(null);
  const [portfolio, setPortfolio] = useState<PortfolioSnapshot[]>([]);
  const [trades, setTrades] = useState<Trade[]>([]);
  const [positions, setPositions] = useState<Position[]>([]);
  const [logs, setLogs] = useState<ActivityLog[]>([]);

  /* ---- Initialize data on mount ---- */
  useEffect(() => {
    setStats(generateDashboardStats());
    setPortfolio(generatePortfolioHistory(30));
    setTrades(generateTradeHistory(10));
    setPositions(generatePositions());
    setLogs(generateActivityLogs(15));
  }, []);

  /* ---- Simulate live updates ---- */
  useEffect(() => {
    /* Add a new trade every 20 seconds */
    const tradeInterval = setInterval(() => {
      const newTrade = generateTrade(SIMULATED_MARKETS);
      setTrades((prev) => [newTrade, ...prev].slice(0, 10));
    }, 20000);

    /* Update stats every 10 seconds */
    const statsInterval = setInterval(() => {
      setStats(generateDashboardStats());
    }, 10000);

    return () => {
      clearInterval(tradeInterval);
      clearInterval(statsInterval);
    };
  }, []);

  /* Loading state */
  if (!stats) {
    return (
      <ClientLayout>
        <div className="flex items-center justify-center h-96">
          <div className="text-accent-green animate-pulse font-mono">
            Initializing terminal...
          </div>
        </div>
      </ClientLayout>
    );
  }

  return (
    <ClientLayout>
      {/* ---- Page header ---- */}
      <div className="mb-6">
        <h1 className="text-2xl font-bold text-foreground tracking-tight">
          <span className="text-accent-green">$</span> Dashboard
        </h1>
        <p className="text-sm text-text-muted mt-1">
          Real-time overview of your AI trading operations
        </p>
      </div>

      {/* ---- Stat cards grid ---- */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <StatCard
          label="Portfolio Value"
          value={formatCurrency(stats.portfolioValue)}
          change={formatPercent(stats.dailyChangePercent)}
          icon={DollarSign}
          variant="green"
        />
        <StatCard
          label="Total P&L"
          value={formatCurrency(stats.totalPnL)}
          change={formatPercent(stats.totalPnLPercent)}
          icon={TrendingUp}
          variant={stats.totalPnL >= 0 ? 'green' : 'red'}
        />
        <StatCard
          label="Win Rate"
          value={`${stats.winRate}%`}
          icon={Target}
          variant="cyan"
        />
        <StatCard
          label="Total Trades"
          value={stats.totalTrades.toString()}
          icon={Zap}
          variant="amber"
        />
      </div>

      {/* ---- Second row: more stats ---- */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <StatCard
          label="Sharpe Ratio"
          value={stats.sharpeRatio.toFixed(2)}
          icon={Award}
          variant="cyan"
        />
        <StatCard
          label="Max Drawdown"
          value={`-${stats.maxDrawdown}%`}
          icon={Shield}
          variant="red"
        />
        <StatCard
          label="Active Positions"
          value={stats.activePositions.toString()}
          icon={BarChart3}
          variant="green"
        />
        <StatCard
          label="Daily Change"
          value={formatCurrency(stats.dailyChange)}
          change={formatPercent(stats.dailyChangePercent)}
          icon={Activity}
          variant={stats.dailyChange >= 0 ? 'green' : 'red'}
        />
      </div>

      {/* ---- Main content: Chart + Activity ---- */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        {/* Portfolio chart — takes 2/3 of the width */}
        <div className="lg:col-span-2 card p-4">
          <h2 className="text-sm font-bold text-foreground mb-4 flex items-center gap-2">
            <TrendingUp className="h-4 w-4 text-accent-green" />
            Portfolio Performance
            <span className="text-xs text-text-muted font-normal">— 30 days</span>
          </h2>
          <PortfolioChart data={portfolio} height={300} />
        </div>

        {/* Activity feed — takes 1/3 */}
        <div className="card p-4 max-h-[420px] overflow-y-auto">
          <h2 className="text-sm font-bold text-foreground mb-4 flex items-center gap-2">
            <Activity className="h-4 w-4 text-accent-cyan" />
            Live Activity
          </h2>
          <ActivityFeed logs={logs} maxItems={10} />
        </div>
      </div>

      {/* ---- Positions ---- */}
      <div className="mb-6">
        <h2 className="text-sm font-bold text-foreground mb-4 flex items-center gap-2">
          <BarChart3 className="h-4 w-4 text-accent-green" />
          Active Positions
        </h2>
        <PositionsList positions={positions} />
      </div>

      {/* ---- Recent Trades ---- */}
      <div>
        <h2 className="text-sm font-bold text-foreground mb-4 flex items-center gap-2">
          <Zap className="h-4 w-4 text-accent-amber" />
          Recent Trades
        </h2>
        <TradeTable trades={trades} />
      </div>
    </ClientLayout>
  );
}
